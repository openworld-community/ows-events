version: '3.7'

x-logging: &default-logging
    driver: json-file
    options:
        max-size: '10m'
        max-file: '5'

networks:
    ows-events_build:
        driver: bridge

services:
    frontend:
        build:
            context: .
            dockerfile: ./frontend/Dockerfile
        logging: *default-logging
        restart: always
        networks:
            - ows-events_build
        ports:
            - '80:3000'
        environment:
            - NUXT_PUBLIC_API_URL=http://backend:7080/api
            - NUXT_PUBLIC_BASE_URL=http://127.0.0.1
            - NUXT_PUBLIC_TELEGRAM_AUTH_BOT_NAME
            - NUXT_PUBLIC_DOMAIN=127.0.0.1
            - NUXT_PUBLIC_GTAG_ID
            - NUXT_PUBLIC_GOOGLE_SIGN_IN_CLIENT_ID
            - NUXT_SITE_ENV=staging
        deploy:
            resources:
                limits:
                    cpus: '0.22'
                    memory: 300M
                reservations:
                    cpus: '0.1'
                    memory: 150M

    backend:
        build:
            context: .
            dockerfile: ./backend/Dockerfile
        logging: *default-logging
        restart: always
        depends_on:
            - mongo
        links:
            - mongo
        environment:
            - MODE=prod
            - MONGO_URI=mongodb://mongo:27017/build
            - FRONTEND_URL=http://127.0.0.1
            - SECRET_KEY
            - LOCALIZATION_API_KEY
            - GITHUB_PARSING_TOKEN
            - PEREDELANOCONF_GOOGLEDOC
            - NUXT_PUBLIC_GOOGLE_SIGN_IN_CLIENT_ID
            - GA_API_SECRET
            - GA_MEASUREMENT_ID
            - S3_ACCESS_KEY_ID
            - S3_SECRET_ACCESS_KEY
            - S3_REGION
            - S3_BUCKET
            - S3_ENDPOINT
        networks:
            - ows-events_build
        ports:
            - '7080:7080'
        volumes:
            - /root/ows-events_build/assets/img:/app/assets/img
        deploy:
            resources:
                limits:
                    cpus: '0.22'
                    memory: 300M
                reservations:
                    cpus: '0.1'
                    memory: 150M

    mongo:
        image: mongo:6.0
        restart: unless-stopped
        command: ['--bind_ip_all']
        ports:
            - '27020:27017'
        networks:
            - ows-events_build
        healthcheck:
            test: test $$(echo "rs.initiate().ok || rs.status().ok" | mongo --quiet) -eq 1
            interval: 10s
            start_period: 30s
        volumes:
            - /root/db/build:/data/db
        deploy:
            resources:
                limits:
                    cpus: '0.4'
                    memory: 400M
                reservations:
                    cpus: '0.2'
                    memory: 200M
